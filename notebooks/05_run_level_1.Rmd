---
title: "HMM (Level 1) State Decoding"
author: "Shreya Bangera"
output:
  pdf_document:
    toc: true              # Enable table of contents
    toc_depth: 3           # Number of header levels to include
    number_sections: true  # Add numbering to sections
---

# 1. Setup
```{r setup, include=FALSE}
# ---- setup ---------------------------------------------------------------
options(warn = 1)
RNGkind("Mersenne-Twister","Inversion","Rejection"); set.seed(123)

# Anchor here() to this file (safe if package is installed via renv)
if (requireNamespace("here", quietly = TRUE)) {
  here::i_am("notebooks/05_run_level_1.Rmd")
}

# Clean chunk defaults for knitting
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE,
  cache   = FALSE,
  error   = TRUE
)

# Single-threaded + deterministic plans are safer when knitting
Sys.setenv(OMP_NUM_THREADS="1", MKL_NUM_THREADS="1", OPENBLAS_NUM_THREADS="1",
           R_FUTURE_FORK_ENABLE="FALSE")

```
 
# 2. Load Packages
```{r Import_Packages}

suppressPackageStartupMessages({
  library(methods)
  library(terra) # must load BEFORE momentuHMM
  library(moveHMM)
  library(momentuHMM)
  library(tidyverse)    # dplyr, ggplot2, readr, etc.
  library(here)
  library(zoo)
  library(circular)
  library(DHARMa)
  library(future)
  library(furrr)
  library(progressr)
})

future::plan(future::sequential)     # safer for knitting
progressr::handlers("txtprogressbar") # optional

```

# 3. Import preprocessed file
```{r Import_preprocessed_csv}

BASE_PATH <- normalizePath(
  here::here(normalizePath(file.path(getwd(), "..","..")),"TEST_COMPASS"),
  winslash = "/",
  mustWork = FALSE
) 

preproc_df <- read.csv(here(BASE_PATH, "csvs",'combined', "Preprocessed_combined_file_exclusions.csv"), stringsAsFactors = TRUE)

```

# 4. Data Cleaning and Processing
```{r Additional_processing}

# Create 'ID' variable as required by momentuHMM
preproc_df$ID <- factor(preproc_df$Genotype)

# Sort data by ID and sequence number
preproc_df <- preproc_df %>%
  arrange(ID,Session, S_no) %>%
  filter(complete.cases(.))  # Remove rows with missing values

```

# 5. Prepare data for HMM
```{r Prepare_HMM}

## Format data using prepData for momentuHMM
final_df <- prepData(preproc_df, type = "UTM", coordNames = c("x", "y"))

# Ensure no missing values remain
final_df <- final_df[complete.cases(final_df), ]

```

# 6. EDA
## 6.1. Step Length Distribution
```{r Best_Model}

# Plot histogram of step lengths
ggplot(final_df, aes(x = step)) +
  geom_histogram(binwidth = 20, fill = "steelblue", color = "black") +
  labs(
    title = "Step Length Distribution",
    x = "Step Length",
    y = "Count"
  ) +
  theme_minimal()

```

## 6.2. Turn Angle Distribution
```{r Model_Evaluation}
# Plot histogram of turning angles
ggplot(final_df, aes(x = angle)) +
  geom_histogram(binwidth = 0.1, fill = "darkorange", color = "black") +
  labs(
    title = "Turning Angle Distribution",
    x = "Angle (radians)",
    y = "Count"
  ) +
  theme_minimal()

```

## 6.3. Summary Statistics
```{r summary_stats}

# Display basic summaries of the step and angle data
summary(final_df$step)
summary(final_df$angle)
```

# 7. Fit Hidden Markov Model (HMM)
```{r hmm}
# ------------------------------------------------------------
#  Run 2-state HMM on preprocessed mouse trajectory data
# ------------------------------------------------------------

# Load utility functions
source(here::here("src","compass_labyrinth","compass","level_1","hmm_utils.R"))

# Prepare your data:
# 'preproc_df' must contain x, y coordinates with sufficient temporal resolution

# Run HMM model selection with default settings
hmm_result <- progressr::with_progress({
  fit_best_hmm(preproc_df,     # your dataframe with x, y
                         n_states = 2,  # number of behavioral states
                         n_iter = 15,   # how many random initializations per config
                         rolling_k = c(3,5,7),   # smoothing windows to test for step/angle
                         opt_methods = c("BFGS", "L-BFGS-B", "Nelder-Mead", "nlm"),   # try both absolute angle and circular angle
                         use_abs_angle = c(TRUE, FALSE),   # try both absolute angle and circular angle
                         use_data_driven_ranges = TRUE,    # dynamically estimate param ranges using IQR/MAD
                         angle_mean_biased = c(pi / 2, 0), # biased angle init (sharp vs straight turns)
                         stationary_flag = "auto",         # fit stationary HMM
                         session_col = "Session",
                         seed = 123)})



# Extract model and summary
best_model <- hmm_result$model
model_summary <- hmm_result$summary

# Print characteristics of the best model
print_hmm_summary(model_summary, best_model)

# Make sure non-NAN in dataframe
hmm_result$data <- hmm_result$data %>%
     filter(complete.cases(.)) 

```

# 8. Visualize results
```{r visualize}
# Visualize results
plot(best_model)
plotPR(best_model)
```

# 9. Optional: access model fit records
```{r optional}
all_model_records <- hmm_result$records
head(all_model_records)
```

# 10. Export csv
```{r Export_csv}

# Example output (uncomment and set a path you have write access to)
# write.csv(hmm_result$data,here(BASE_PATH, "csvs",'combined', "HMM_2State_file.csv"), row.names = FALSE)

```
